---
title: "Income of households by NUTS 2"
author: "Aythami Lorenzo"
date: "`r Sys.Date()`"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  cache=FALSE,  
  echo=FALSE
)
```

```{css estilo, results = 'asis', echo = FALSE}
<style>

/* --- 1. IMPORTACIÓN DE FUENTE MODERNA --- */
@import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap");

/* --- 2. ESTILO GENERAL Y FONDO --- */
body {
    font-family: "Montserrat", sans-serif;
    font-weight: 400; 
    font-size: 1em; 
    color: #2c3e50; 
    background-color: #f0f4f8; 
}

/* --- 3. CABECERA Y NAVEGACIÓN --- */
.navbar {
    background-color: #0072B2 !important; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); 
}
.navbar-brand, .navbar-nav > li > a {
    color: #ffffff !important;
    font-weight: 600;
    transition: background-color 0.3s ease, color 0.3s ease; /* Transición suave */
}

/* --- NUEVAS REGLAS DE HOVER Y TRANSICIÓN --- */

/* 1. Efecto HOVER: Resalta en blanco */
.navbar-nav > li > a:hover {
    color: #0072B2 !important; /* Texto cambia a azul corporativo */
    background-color: #ffffff !important; /* Fondo cambia a blanco */
    border-radius: 6px; 
}

/* 2. Regla para la Pestaña Activa (se mantiene blanca) */
.nav-tabs>li.active>a, .nav-tabs>li.active>a:focus, .nav-tabs>li.active>a:hover {
    color: #0072B2 !important; 
    background-color: #ffffff !important;
    font-weight: 700;
    border-radius: 8px 8px 0 0;
}
/* Asegurar que la pestaña activa no pierda el estilo al hacer hover */
.nav-tabs>li.active>a:hover {
    background-color: #ffffff !important; 
    color: #0072B2 !important;
}

/* --- 4. ESTILO DE LAS CAJAS/PANELES (TARJETAS FLOTANTES) --- */
.box, .panel-default {
    border: none !important;
    border-radius: 12px; 
    background-color: #ffffff;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
    margin-bottom: 25px;
    padding: 15px;
}

/* 5. TÍTULOS Y CONTROLES */
.panel-title {
    color: #0072B2; 
    font-weight: 700; 
    font-size: 1.1em; 
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f4f8;
}
.shiny-input-container label {
    font-weight: 600;
    color: #34495e;
}
.selectize-input {
    border-radius: 6px;
    border: 1px solid #dddddd;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); 
}
.slider-animate-button, .slider-track-high {
    background-color: #0072B2 !important; 
}
/* Estilo para la leyenda del mapa */
.legend.leaflet-control {
    border-radius: 10px !important;
    padding: 12px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
</style>
```


```{r global, include=FALSE}
# carga de librerías
library(pxR)
library(patchwork)
library(MASS)
library(flexdashboard)
library(datasets)
library(highcharter) 
library(fpp3)
library(RColorBrewer)
library(openxlsx)  
library(leaflet)  
library(geojsonio)
library(plotly)
library(ggplot2)
library(tidyverse)
source("utilidades.R")

# asociamos funciones a determinadas librerías para evitar posibles errores 
filter <- dplyr::filter # Filtra filas según condiciones
select <- dplyr::select # Selecciona columnas
mutate <- dplyr::mutate # Crea o modifica columnas
arrange <- dplyr::arrange # Ordena filas
group_by <- dplyr::group_by # Agrupa datos
summarise <- dplyr::summarise # Resume variables (por ejemplo, con medias, conteos)
summarize <- dplyr::summarize # Lo mismo que summarise
rename <- dplyr::rename # Cambia nombres de columnas
distinct <- dplyr::distinct # Elimina filas duplicadas
slice<- dplyr::slice # Selecciona filas por posición
relocate<- dplyr::relocate # Reordena columnas

selectInput <- shiny::selectInput
```

```{r}
geoj <- geojson_read("https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_20M_2024_4326_LEVL_0.geojson",  what = "sp")
geoj.tb <- geoj %>% as_tibble()
```

```{r}
geoj2 <- geojson_read("https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_20M_2024_4326_LEVL_2.geojson", what = 'sp')

geoj2.tb <- geoj2 %>% 
  as_tibble() %>% 
  rename(geo = NUTS_ID)

```

```{r}

# Diccionario maestro de códigos a nombres usado para la leyenda de los mapas coropléticos
master_indicadores <- c(
  "Ingreso primario neto" = "B5N",
  "Renta disponible neta" = "B6N",
  "Ahorro neto" = 'B7N',
  "Remuneración de los asalariados" = "D1",
  "Prestaciones sociales recibidas" = "D62",
  "Impuestos sobre renta y patrimonio" = "D5",
  "Rentas de la propiedad" = "D4",
  "Gasto en consumo final" = "P3",
  "Inversión en activos fijos" = "P51C"
)
```


```{r}
# dataset.name <- "nama_10r_2hhinc"
# data <- get_eurostat(dataset.name, time_format = 'date') %>%
  # as_tibble() %>%
  # arrange(TIME_PERIOD, geo)

data <- read.csv("nama_10r_2hhinc.csv") %>% 
  as_tibble() %>% 
  mutate(TIME_PERIOD = as.Date(TIME_PERIOD)) %>% 
  arrange(TIME_PERIOD, geo) 

```

```{r}
data <- data %>%
  mutate(TIME_PERIOD = as.numeric(format(TIME_PERIOD, "%Y"))) %>%
  filter(TIME_PERIOD > 1999 & TIME_PERIOD < 2023)


NUTS <- read_csv('http://ctim.es/AEDV/data/eurostac_real_nuts.csv')%>%
  as_tibble() 
  

data <- data %>%
  left_join(NUTS, by = 'geo') %>%
  relocate(full_name, freq, unit, direct, na_item, geo, TIME_PERIOD, values, .after = data$NUTS) %>% 
  mutate(full_name = ifelse(geo == "EU27_2020", "Media UE", full_name)) 




```


```{r message=FALSE, warning=FALSE, results= 'hide'}
poblacion <- read.csv("poblacion.csv") %>% 
  as_tibble() %>% 
  mutate(TIME_PERIOD = as.numeric(format(as.Date(TIME_PERIOD), "%Y"))) %>% 
  rename(poblacion = values) %>% 
  select(-freq, -unit)



```



Series Temporales
=======================================================================


Column {.sidebar data-width=290}
--------------------------------------------------



```{r}
output$Indicador.paises.dinamico.ui <- shiny::renderUI({
  
  req(input$Alcance)
  
  if(input$Alcance == "Países") {
  if(input$Unidad.series == "PPS_EU27_2020_HAB") {
    opciones <- c(
      "Todos los indicadores",
      "Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N")
  } else {
    opciones <- c(
      "Todos los indicadores",
      "Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N",
      "Remuneración de los asalariados" = "D1",
      "Prestaciones sociales recibidas" = "D62",
      "Impuestos sobre renta y patrimonio" = "D5",
      "Rentas de la propiedad" = "D4")
  }
  } else {
      opciones <- c(
        "Todos los indicadores",
      "Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C")
}
    shiny::selectInput(
      "Indicador.series",
      label = "Indicador",
      choices = opciones,
      selected = "B6N",
      width = '240px' 
    )

})
```

```{r}
    shiny::selectInput(
      "Alcance",
      label = "Alcance",
      choices = c(
        "Países",
        "Comunidades España"
      ),
      selected = "Países"
    )
    
    shiny::uiOutput("Indicador.paises.dinamico.ui")
    

  conditionalPanel(
    condition = "input.Alcance == 'Países' && input['Indicador.series'] != 'Todos los indicadores'",
    shiny::selectInput(
      "Unidad.series",
      label = "Unidad",
      choices = c(
        "€ por habitante" = "EUR_HAB",
        "Unidades PPS por habitante" = "PPS_EU27_2020_HAB"),
      selected = "EUR_HAB",
      width = '240px' 
    )
  )
  
    opciones.series.paises  <- data %>% 
      filter((NUTS == 0 | full_name == 'Canarias' | NUTS == 'EU27_2020')) %>% 
      mutate(
    full_name = ifelse(geo == "EU27_2020", "Media UE", full_name)) %>%
  arrange(full_name)
    
      
  conditionalPanel(
    condition = "input.Alcance == 'Países' && input['Indicador.series'] != 'Todos los indicadores'", 
    shiny::selectInput(
      "Paises.series",
      label = "Países",
      choices = unique(opciones.series.paises$full_name),
      selected = c("Canarias", "Spain", "Media UE", "France", "Portugal", "Germany"),
      multiple = TRUE
    )
  )
  
    opciones.series.comunidades  <- data %>% 
      filter(((NUTS == 2 & substr(geo,1,2) == 'ES') | geo == 'EU27_2020')) %>% 
            mutate(
    full_name = ifelse(geo == "EU27_2020", "Media UE", full_name)) %>%
  arrange(full_name)
    
  conditionalPanel(
    condition = "input.Alcance == 'Comunidades España' && input['Indicador.series'] != 'Todos los indicadores'",
    shiny::selectInput(
      "Comunidades.series",
      label = "Comunidades",
      choices = unique(opciones.series.comunidades$full_name),
      selected = c("Canarias", "Andalucía", "Comunidad de Madrid", "Extremadura", "Media UE", "País Vasco"),
      multiple = TRUE
    )
  )
  
  
    conditionalPanel(
    condition = "input.Alcance == 'Países' && input['Indicador.series'] == 'Todos los indicadores'", 
    shiny::selectInput(
      "Paises.series2",
      label = "País",
      choices = unique((data %>% filter(NUTS == 0))$full_name),
      selected = "Spain"
    )
  )
    
  conditionalPanel(
    condition = "input.Alcance == 'Comunidades España' && input['Indicador.series'] == 'Todos los indicadores'", 
    shiny::selectInput(
      "Comunidades.series2",
      label = "Comunidad",
      choices = unique((data %>% filter(NUTS == 2, substr(geo,1,2) == 'ES'))$full_name),
      selected = "Canarias"
    )
  )
  
    
  shiny::checkboxInput(
    "Escala.series",
    label = "Escala del eje y libre",
    value = FALSE
  )
```


```{r}
input.processing.series.temporales <- reactive({
  
  if(input$Indicador.series == "Todos los indicadores") {
    
    unidad = "€/HAB"  
    
  } else if(input$Alcance == "Países") {
    
  if (input$Unidad.series == 'EUR_HAB') {
    
    unidad = "€/HAB"
    
  } else {
    
    unidad = "PPS/HAB"
    
  }
  } else {
    
    unidad = "€/HAB"
  }  
  
  
  
  if(input$Indicador.series == "Todos los indicadores") {
    
    nombres_legibles <- c(
    "B5N" = "Ingreso primario neto",
    "B6N" = "Renta disponible neta",
    "B7N" = "Ahorro neto",
    "D1"  = "Remuneración asalariados",
    "D62" = "Prestaciones sociales recibidas",
    "D5"  = "Impuestos renta/patrimonio",
    "D4"  = "Rentas propiedad",
    "P3"  = "Gasto consumo final",
    "P51C" = "Inversión activos fijos"
  )

    todos_codigos.paises <- c("B5N", "B6N", "D1", "D62", "D5", "D4")
    todos_codigos.comunidades <- c("B5N", "B6N", "B7N", "D1", "D62", "D5", "D4", "P3", "P51C")
    
    if(input$Alcance == "Países") {
      
      tb <- data %>% 
        filter(NUTS == 0, full_name == input$Paises.series2[1], na_item %in% todos_codigos.paises, unit == "MIO_EUR", (!na_item %in% c("D4", "D62") | direct == "RECV")) %>% 
        rename(Región = full_name,
               valores = values) %>% 
        left_join(poblacion, by = c("geo", "TIME_PERIOD")) %>% 
        mutate(per.capita = (valores * 1000000) / (poblacion * 1000)) %>% 
        select(-valores) %>% 
        rename(valores = per.capita)
      
          tb <- tb %>% mutate(na_item = dplyr::recode(na_item, !!!nombres_legibles))
      
          text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
          
          return(list(tb, text))
      
    } else if(input$Alcance == "Comunidades España") {
      
           tb <- data %>% 
        filter(NUTS == 2, full_name == input$Comunidades.series2[1], na_item %in% todos_codigos.comunidades, unit == "MIO_EUR", (!na_item %in% c("D4", "D62") | direct == "RECV")) %>% 
        rename(Región = full_name,
               valores = values) %>% 
        left_join(poblacion, by = c("geo", "TIME_PERIOD")) %>% 
        mutate(per.capita = (valores * 1000000) / (poblacion * 1000)) %>% 
        select(-valores) %>% 
        rename(valores = per.capita)
      
          tb <- tb %>% mutate(na_item = dplyr::recode(na_item, !!!nombres_legibles))
          
          text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
          
          return(list(tb, text))
      
    }  
    
  }
  
  
  
  if(input$Alcance == "Países") {
    if(input$Indicador.series %in%  c("B5N", "B6N")) {
      
      tb <- data %>% 
        filter((NUTS == 0 | full_name == 'Canarias' | NUTS == 'EU27_2020'), na_item == input$Indicador.series, unit == input$Unidad.series & full_name %in% input$Paises.series) %>% 
        rename(Región = full_name,
               valores = values) %>% 
        mutate(
    grupo_color = ifelse(Región %in% c("Canarias", "Spain", "Media UE"), "Destacado", "Otras Regiones"),
    Región = forcats::fct_relevel(Región, "Canarias", "Spain", "Media UE") 
  )
      
      text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
      
    } else if(input$Indicador.series %in% c("D4", "D62")) {
      tb <- data %>% 
        filter((NUTS == 0 | full_name == 'Canarias' | NUTS == 'EU27_2020'), na_item == input$Indicador.series, unit == "MIO_EUR" &  full_name %in% input$Paises.series, direct == "RECV") %>% 
        left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(Región = full_name,
               valores = per.capita) %>% 
        mutate(
    grupo_color = ifelse(Región %in% c("Canarias", "Spain", "Media UE"), "Destacado", "Otras Regiones"),
    Región = forcats::fct_relevel(Región, "Canarias", "Spain", "Media UE") 
  )
      
          text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
      
    } else {
      
      tb <- data %>% 
        filter((NUTS == 0 | full_name == 'Canarias' | NUTS == 'EU27_2020'), na_item == input$Indicador.series, unit == "MIO_EUR" & full_name %in% input$Paises.series) %>% 
        left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(Región = full_name,
               valores = per.capita) %>% 
        mutate(
    grupo_color = ifelse(Región %in% c("Canarias", "Spain", "Media UE"), "Destacado", "Otras Regiones"),
    Región = forcats::fct_relevel(Región, "Canarias", "Spain", "Media UE") 
  )
      
          text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
      
    }
  } else if(input$Indicador.series %in%  c("B5N", "B6N", "B7N")) {
      
      tb <- data %>% 
        filter((NUTS == 2 | geo == 'EU27_2020'), na_item == input$Indicador.series, unit == "EUR_HAB" & full_name %in% input$Comunidades.series) %>% 
        rename(Región = full_name,
               valores = values) %>% 
        mutate(
    grupo_color = ifelse(Región %in% c("Canarias", "Media UE"), "Destacado", "Otras Regiones"),
    Región = forcats::fct_relevel(Región, "Canarias", "Media UE") 
  )
      
      
            text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
      
  } else if(input$Indicador.series %in% c("D4", "D62")) {
      tb <- data %>% 
        filter((NUTS == 2 | geo == 'EU27_2020'), na_item == input$Indicador.series, unit == "MIO_EUR" & direct == "RECV" & full_name %in% input$Comunidades.series) %>% 
        left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(Región = full_name,
               valores = per.capita) %>% 
        mutate(
    grupo_color = ifelse(Región %in% c("Canarias", "Media UE"), "Destacado", "Otras Regiones"),
    Región = forcats::fct_relevel(Región, "Canarias", "Media UE") 
  )
      
      
            text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
      
  } else {
    
          tb <- data %>% 
        filter((NUTS == 2 | geo == 'EU27_2020'), na_item == input$Indicador.series & full_name %in% input$Comunidades.series) %>% 
        left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(Región = full_name,
               valores = per.capita) %>% 
              mutate(
    grupo_color = ifelse(Región %in% c("Canarias", "Media UE"), "Destacado", "Otras Regiones"),
    Región = forcats::fct_relevel(Región, "Canarias", "Media UE") 
  )
          
                text = paste("Año: ", tb$TIME_PERIOD,
                   "<br>valores: ", round(tb$valores,1), unidad)
    
  }
  
  return(list(tb, text))

})
```


```{r}
renderTable({
  
  tb <- input.processing.series.temporales()[[1]]
  
  tb %>% 
    filter((NUTS == 0 | NUTS == 2)) %>% 
    arrange(desc(TIME_PERIOD)) %>% 
    rename(Año = TIME_PERIOD) %>% 
    mutate(Año = as.character(Año),
           valores=prettyNum(round(valores,
digits=max(5-nchar(as.character(round(max(na.omit(valores))))),0)),big.mark = ",")) %>% 
    select(Región, Año, valores)
  
  
    
  
})
```

Column
-------------------------------

###

```{r}
renderPlotly({
  
  tb <- input.processing.series.temporales()[[1]]
  text <- input.processing.series.temporales()[[2]]
  
  if(input$Escala.series == TRUE) {
    escala = "free_y"
  } else {
    
    escala = "fixed"
  }
  
  if(input$Indicador.series != "Todos los indicadores") {
  p <- tb %>%
    ggplot(aes(x = TIME_PERIOD,
               y = valores, 
               color = grupo_color,
               group = Región,
               text = text)) +
    geom_line(linewidth = 0.8) + 
        scale_color_manual(values = c(
      "Destacado" = "red",
      "Otras Regiones" = "#0072B2"
    )) +
    facet_wrap(~ Región,
               labeller = labeller(full_name = label_wrap_gen(width = 15)), scales = escala) +
    theme_minimal() + 
    labs(x = "Año", y = "") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    theme(panel.spacing.x = unit(1, "lines")) +
    theme(legend.position = "none") +
    theme(plot.margin = margin(t = 5, r = 5, b = 80, l = 15))
  } else {
    
    p <- tb %>%
    ggplot(aes(x = TIME_PERIOD,
               y = valores, 
              color = na_item,
              group = na_item,
               text = text)) +
    geom_line(linewidth = 0.8) + 
    facet_wrap(~ na_item, scales = escala) +
    theme_minimal() + 
    labs(title = paste("Indicadores para", unique(tb$Región), "(€/HAB)"), x = "Año", y = "") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    theme(panel.spacing.x = unit(1, "lines")) +
    theme(legend.position = "none") +
    theme(plot.margin = margin(t = 5, r = 5, b = 80, l = 15))
  }
  ggplotly(p, tooltip = "text")
})

```


Atributos por año 
================================================

Column {.sidebar data-width=260}
-------------------------------------------------

```{r}

shiny::uiOutput("Indicador.mapa.dinamico")

output$Indicador.mapa.dinamico <- shiny::renderUI({
  
  if(input$NUTS == 2) {
    if(input$Unidad == "PPS_EU27_2020_HAB") {

        opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N")
        
    } else {
      
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C")
    }
    
  } else {
    
    if(input$Unidad == "PPS_EU27_2020_HAB") {

        opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N")
        
    } else {
    
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4")
    }
  }
  
  shiny::selectInput(
    "Indicador.mapa",
    label = "Indicador",
    choices = opciones,
    selected = "B6N"
  )
  
})

shiny::selectInput(
  "Unidad",
  label = "Unidad",
  choices = c(
    "Unidades PPS por habitante" = "PPS_EU27_2020_HAB",
    "€ por habitante" = "EUR_HAB"),
  selected = "EUR_HAB"
)

shiny::selectInput(
  "NUTS",
  label = "NUTS",
  choices = c("0",
              "2"),
  selected = "2"
)


shiny::sliderInput(
  "Año",
  label = "Año",
  min = first(data$TIME_PERIOD),
  max = last(data$TIME_PERIOD),
  value = 2016,
  step = 1,
  
  ticks = FALSE
)
```



```{r}
input.processing.atributo.año <- reactive({
    
  
    if(input$Indicador.mapa %in% c('B5N', 'B6N')) {
    tb <- data %>% 
    filter(na_item == input$Indicador.mapa & TIME_PERIOD == input$Año 
           & unit == input$Unidad & NUTS == input$NUTS) 
      
      if(input$Unidad == 'EUR_HAB'){
        unidad = '€/HAB'
      } else {
        
        unidad = "PPS/HAB"
        
      }
      
    } else if(input$Indicador.mapa %in% c('D4', 'D62')) {
      
      tb <- data %>% 
    filter(na_item == input$Indicador.mapa & TIME_PERIOD == input$Año 
           & unit == "MIO_EUR" & NUTS == input$NUTS & direct == 'RECV') 
      
      tb <- tb %>% 
        left_join(poblacion, by = c('TIME_PERIOD', 'geo')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(values = per.capita)
      
      unidad = "€/HAB"
    } else {
      
            tb <- data %>% 
    filter(na_item == input$Indicador.mapa & TIME_PERIOD == input$Año 
           & unit == "MIO_EUR" & NUTS == input$NUTS) 
      
      tb <- tb %>% 
        left_join(poblacion, by = c('TIME_PERIOD', 'geo')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(values = per.capita)
      
      unidad = "€/HAB"
    }
  
  return(list(tb, unidad))
  
})
```

### 

```{r}
shiny::renderTable({
  
  tb <- input.processing.atributo.año()[[1]] %>% 
    arrange(desc(values)) %>% 
    select(full_name, values) %>% 
    rename(Región = full_name,
           valores = values)

  tb %>% 
 mutate(valores=prettyNum(
  round(valores,
   digits=max(5-nchar(as.character(round(max(na.omit(valores))))),0)
  ),
  big.mark = ",")
 ) 
  
})
```

```{r}
input.processing.atributo.año.join <- reactive({
  
  tb <- input.processing.atributo.año()[[1]]
  unidad <- input.processing.atributo.año()[[2]]
  
  indicador<- input$Indicador.mapa
  legend_name <- names(master_indicadores)[master_indicadores == indicador]
  
  legend_title_break <- legend_name %>%
    stringr::str_replace(" sobre ", " sobre <br>") %>%
    stringr::str_replace(" de los ", " de los <br>") %>%
    stringr::str_replace(" y ", " y <br>") %>% 
    stringr::str_replace(" en ", " en <br>") %>% 
    stringr::str_replace(" primario ", " primario <br>") %>% 
    stringr::str_replace(" disponible ", " disponible <br>") %>% 
    stringr::str_replace("Ingreso ", "Ingreso <br>") %>% 
    stringr::str_replace("Renta ", "Renta <br>") %>% 
    stringr::str_replace("Prestaciones ", "Prestaciones <br>") %>% 
    stringr::str_replace(" sociales ", " sociales <br>") %>% 
    stringr::str_replace(" la ", " la <br>") 
    
  
  if (input$NUTS == "0") {
    tb <- geoj.tb %>% 
      rename(geo = NUTS_ID) %>% 
   left_join(tb, by = "geo")
    
    valor_formateado <- prettyNum(round(tb$values,digits=2), big.mark = ",", scientific = FALSE)

    etiqueta_valor <- ifelse(is.na(tb$values), 
                             "N/A", 
                             valor_formateado)

    etiqueta_unidad <- ifelse(is.na(tb$values), 
                              "", 
                              paste0("<strong>", unidad, "</strong>"))
    
etiquetas <-paste(
   "<strong> ",tb$NUTS_NAME , 
   "</strong><br>",
   "<strong>Valor: </strong>", etiqueta_valor, etiqueta_unidad) %>%
 lapply(htmltools::HTML)
    
    mapa = geoj
    funcion = MapaCoroplético
    
  } else {
    
    tb <- geoj2.tb %>% 
      left_join(tb, by = 'geo')

    valor_formateado <- prettyNum(round(tb$values,digits=2), big.mark = ",", scientific = FALSE)

    etiqueta_valor <- ifelse(is.na(tb$values), 
                             "N/A", 
                             valor_formateado)

    etiqueta_unidad <- ifelse(is.na(tb$values), 
                              "", 
                              paste0("<strong>", unidad, "</strong>"))        
    
    
    etiquetas <-paste(
    "<strong>", tb$NUTS_NAME,
    "</strong><br><strong>Valor: </strong>", etiqueta_valor,"<strong>",etiqueta_unidad,"</strong>")  %>%
 lapply(htmltools::HTML)
    
    mapa = geoj2
    funcion = MapaCoroplético
  }
  
  return(list(tb, mapa, etiquetas, funcion, legend_title_break))
  
})

```



Column
--------------------------------------------

###


```{r}
leaflet::renderLeaflet({
  
 tb <- input.processing.atributo.año.join()[[1]]
 mapa <- input.processing.atributo.año.join()[[2]]
 etiquetas <- input.processing.atributo.año.join()[[3]]
 funcion <- input.processing.atributo.año.join()[[4]]
 leyenda <- input.processing.atributo.año.join()[[5]]
 
 
 funcion(mapa,tb$values,etiquetas,leyenda)
})

```

Comparación Atributos
==================================================

Column {.sidebar data-width=250}
--------------------------------------------------


```{r inicio_comparacion}


shiny::selectInput(
  "Alcance.comparacion",
  label = "Alcance",
  choices = c("Países", "Comunidades España"),
  selected = "Países"
)


shiny::uiOutput("Indicadores.comparacion.ui.x")

selectInput(
  "x_scale", 
  label = "Transformación del atributo x",
  choices = c("none",
              "sqrt",    
              "log"
             ), 
  selected = "none"
)

shiny::uiOutput("Indicadores.comparacion.ui.y")


selectInput(
  "y_scale", 
  label = "Transformación del atributo y",
  choices = c("none",
              "log",
              "YeoJohnson"
             ), 
  selected = "none"
)
output$Indicadores.comparacion.ui.x <- shiny::renderUI({
  
  req(input$Alcance.comparacion)
  
  if (input$Alcance.comparacion == "Países") {
    
    opciones <- c(
      "Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N",
      "Remuneración de los asalariados" = "D1",
      "Prestaciones sociales recibidas" = "D62",
      "Impuestos sobre renta y patrimonio" = "D5",
      "Rentas de la propiedad" = "D4"
    )
  } else {

    opciones <- c(
      "Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C"
    )
  }
  
   
      shiny::selectInput(
        "X", 
        label = "x: Atributo 1",
        choices = opciones,
        selected = "B6N"
      )
    
  
})


output$Indicadores.comparacion.ui.y <- shiny::renderUI({
  
  req(input$Alcance.comparacion)
  
  if (input$Alcance.comparacion == "Países") {
    
    opciones <- c(
      "Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N",
      "Remuneración de los asalariados" = "D1",
      "Prestaciones sociales recibidas" = "D62",
      "Impuestos sobre renta y patrimonio" = "D5",
      "Rentas de la propiedad" = "D4"
    )
  } else {

    opciones <- c(
      "Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C"
    )
  }
  
   
      shiny::selectInput(
        "Y", 
        label = "y: Atributo 2",
        choices = opciones,
        selected = "B5N"
      )
    
  
})


shiny::selectInput(
  "Año.comparacion",
  label = "Año",
  choices = c("Todos",sort(unique(data$TIME_PERIOD), decreasing = TRUE)),
  selected = "Todos"
)

lista_paises <- data %>% 
  filter(NUTS == 0) 
   


conditionalPanel(
  condition = "input['Alcance.comparacion'] == 'Países'",
    shiny::selectInput(
  "Pais.comparacion",
  label = "País",
  choices = unique(lista_paises$full_name),
  selected = "Spain"
  )
)

lista_comunidades <- data %>% 
  filter(NUTS == 2 & substr(geo,1,2) == 'ES') 

conditionalPanel(
  condition = "input['Alcance.comparacion'] == 'Comunidades España'",
  
  shiny::selectInput(
    "Comunidad.comparacion",
    label = "Región",
    choices = unique(lista_comunidades$full_name),
    selected = "Canarias"
  )
)

```


```{r}
input.processing.comparacion <- reactive({
  
  
  data %>% 
    filter(NUTS == 0, full_name == 'Spain', na_item  %in% c("B6N","D4"), unit == "MIO_EUR", (!na_item %in% c("D4", "D62") | direct == "RECV")) %>% 
    left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>%
      mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
      select(-values) %>% 
      rename(values = per.capita) %>% 
      select(-direct) %>% 
    pivot_wider(names_from = na_item, values_from = values) %>% 
    select(Región = full_name, Año = TIME_PERIOD, x = B6N, y = D4) %>% 
      na.omit()
      
  
  
  if(input$Alcance.comparacion == "Países") {
    
    tb <- data %>% 
      filter(NUTS == 0, full_name == input$Pais.comparacion, na_item %in% c(input$X, input$Y), unit == "MIO_EUR", (!na_item %in% c("D4", "D62") | direct == "RECV")) %>%
      left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>%
      mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
      select(-values) %>% 
      rename(values = per.capita) %>% 
      select(-direct) %>% 
      pivot_wider(names_from = na_item, values_from = values) %>% 
      select(Región = full_name, Año = TIME_PERIOD, x = input$X, y = input$Y) %>% 
      na.omit()
    
  } else {
    
    tb <- data %>% 
      filter(NUTS == 2, full_name == input$Comunidad.comparacion, na_item %in% c(input$X, input$Y), unit == 'MIO_EUR', (!na_item %in% c("D4", "D62") | direct == "RECV")) %>%
      left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>%
      mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
      select(-values) %>% 
      rename(values = per.capita) %>% 
      select(-direct) %>% 
      pivot_wider(names_from = na_item, values_from = values) %>% 
      select(Región = full_name, Año = TIME_PERIOD, x = input$X, y = input$Y) %>% 
      na.omit()
    
  }
  
    if(input$Año.comparacion != 'Todos'){
    tb <- tb %>%
      filter(Año == input$Año.comparacion)
    } 
  
  
    # transformados los indicadores de acuerdo con los parámetros de la transformación
  if(input$x_scale=="sqrt") tb$x <- sign(tb$x)*sqrt(abs(tb$x))
  if(input$x_scale=="log") tb$x <-  sign(tb$x)*log(abs(tb$x))
  if(input$y_scale=="log") tb$y <-  sign(tb$y)*log(abs(tb$y))
  lambda <- 1  
  if(input$y_scale=="YeoJohnson"){
    lambda <- optimize.yeojohnson.R2(tb$x, tb$y) # Cálculo óptimo modelo Yeo-Jonhson 
    tb$y <- yeo.johnson(tb$y,lambda)
  }
  
  tb <- tb %>% 
    na.omit()
  # Cálculo regresión lineal después de transformar las variables. 
  fit <- lm(y ~ x,data=tb)
  
  # devolvemos una lista con todo lo calculado 
  return(list(tb,fit,lambda))
  
})
```

```{r}
# imprimimos en formato HTML los resultados del análisis de regresión 
# de los indicadores seleccionados transformados
shiny::renderUI({
  
  # capturamos el resultado del procesado de los inputs 
  tb <- input.processing.comparacion()[[1]]
  fit <- input.processing.comparacion()[[2]]
  lambda <- input.processing.comparacion()[[3]]
  
  # imprimimos el resultado en formato HTML 
  text <- paste(
    "<strong>LINEAR REGRESSION ANALYSIS</strong> <br>",
    "<strong>formula:   y=ax+b </strong><br>",
    "<strong>x: Atributo 1 scaled </strong><br>",
    "<strong>y: Atributo 2 scaled </strong><br>",
    "<strong><br>RESULTS</strong><br>",
    "<strong>correlation:</strong>",round(cor(tb$x,tb$y),digits = 8),
    "<br><strong>slope (a):</strong>",formatC(fit$coefficients[2], format = "e", digits = 3),
    "<br><strong>independent (b):</strong>",formatC(fit$coefficients[1], format = "e", digits = 3)
  )
  if(input$y_scale=="YeoJohnson"){
    text <- paste(text,"<br><strong> lambda (YeoJohnson) :</strong>",formatC(lambda, format = "e", digits = 3))
  } 
  text <- paste(text,
     "<br><strong>sd(residuos):</strong>",formatC(summary(fit)$sigma, format = "e", digits = 3),
     "<br><strong>R2:</strong>",round(summary(fit)$r.squared, digits = 8)           
  )
      
  HTML(text)
})
```

Column
-------------------------------------------

### 
```{r}
renderPlotly({
  
  tb <- input.processing.comparacion()[[1]] 
  
  
    tb %>%
    ggplot(aes(x,
               y)) + 
    geom_point() +
    theme(legend.position = "none") +
    labs(x= input$x, y= input$y) +
    geom_smooth(method = lm, se = FALSE) + 
      labs(x = "€/HAB",
           y = "€/HAB")
})
```

Column {data-width=240}
--------------------------------------------------

```{r}
renderTable({
  
  # capturamos el resultado del procesado de los inputs 
  tb <- input.processing.comparacion()[[1]]
  
  # imprimimos la tabla 
  tb %>% 
  arrange(desc(x)) %>% 
  mutate(Año = input$Año.comparacion) %>% 
  mutate(x=prettyNum(round(x,digits=2), big.mark = ",")) %>% 
  mutate(y=prettyNum(round(y,digits=2), big.mark = ","))
  
})
```


ARIMA 
==================================================

Column {.sidebar data-width=290}
--------------------------------------------------

```{r}

shiny::selectInput(
 "Scope",
 label = "Alcance del Análisis:",
 choices = c("Países", "Comunidades España"),
 selected = "Países"
)


output$Indicador.arima.dinamico <- shiny::renderUI({
  
  if(input$Scope == "Países") {
    # Lógica para PAÍSES (Depende de input$Unidad.arima)
    if(input$Unidad.arima == "EUR_HAB") {
      opciones <- c("Ingreso primario neto" = "B5N",
        "Renta disponible neta" = "B6N",
        "Remuneración de los asalariados" = "D1",
        "Prestaciones sociales recibidas" = "D62",
        "Impuestos sobre renta y patrimonio" = "D5",
        "Rentas de la propiedad" = "D4")
    } else {
      opciones <- c("Ingreso primario neto" = "B5N",
        "Renta disponible neta" = "B6N")
    }
    
  } else {
    # Lógica para Comunidades ESPAÑA (Unidad Fija: EUR_HAB)
    
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C")
  }
  
  shiny::selectInput(
    "Indicador.arima",
    label = "Indicador",
    choices = opciones,
    selected = "B6N"
  )
})

shiny::uiOutput("Indicador.arima.dinamico")

opciones <- data %>% 
  filter(NUTS == 0)

conditionalPanel(
  condition = "input.Scope == 'Países'",
shiny::selectInput(
  "Pais",
  label = "Países (máx 2)",
  choices = unique(opciones$full_name),
  selected = c("Spain", "Portugal"),
  multiple = TRUE
  )
)

conditionalPanel(
  condition = "input.Scope == 'Países'",
shiny::selectInput(
  "Unidad.arima",
  label = "Unidad",
  choices = c(
    "€ por habitante" = 'EUR_HAB',
    "Unidades PPS por habitante" = 'PPS_EU27_2020_HAB'),
  selected = "EUR_HAB"
  )
)

opciones_prov_full <- data %>%
 filter(substr(geo, 1, 2) == 'ES' & NUTS == 2) # Usamos las NUTS 2 de España

conditionalPanel(
  condition = "input.Scope == 'Comunidades España'",
  shiny::selectInput(
 "Comunidad", 
 label = "Comunidades (múltiples)",
 choices = unique(opciones_prov_full$full_name), 
 selected = c("Canarias", "Andalucía"),
 multiple = TRUE
  )
)

shiny::selectInput(
  "AñoInicialArima", 
  label = "Año Inicial para cálculo ARIMA",
  choices = unique(data$TIME_PERIOD) , 
  selected = first(data$TIME_PERIOD)
)

numericInput(
  "Number.forecast.periods",
  label = "N. Periodos Predicción:",
  value=5,
  min=2,
  max=30,
  step=1
)

selectInput(
  "ArimaParameters", 
  label = "Parámetros ARIMA p/d/q",
  choices = c('free', '0/2/0', '1/2/1', '2/2/2', '0/1/0', '1/1/1', '2/1/2'),  
  selected = 'free'
)

```

```{r}
input.processing.arima <- reactive({
  
  if (input$Scope == 'Países') {
  if(input$Indicador.arima %in% c('B5N', 'B6N')) {
      
    tb <- data %>% 
    filter(na_item == input$Indicador.arima & unit == input$Unidad.arima & NUTS == 0) %>%
    rename(Región = full_name,
           Año = TIME_PERIOD,
           valores = values) %>%
    filter(Región %in% input$Pais[1:2]) 
    
  } else if(input$Indicador.arima %in% c('D4', 'D62')) {
    
        tb <- data %>% 
    filter(na_item == input$Indicador.arima & unit == 'MIO_EUR' & NUTS == 0 & direct == 'RECV') %>%
    left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>% 
          mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
          select(-values) %>% 
    rename(Región = full_name,
           Año = TIME_PERIOD,
           valores = per.capita) %>%
    filter(Región %in% input$Pais[1:2]) 
         
        
  } else {
    
            tb <- data %>% 
    filter(na_item == input$Indicador.arima & unit == 'MIO_EUR' & NUTS == 0) %>%
    left_join(poblacion, by = c('geo', 'TIME_PERIOD')) %>% 
          mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
          select(-values) %>% 
    rename(Región = full_name,
           Año = TIME_PERIOD,
           valores = per.capita) %>%
    filter(Región %in% input$Pais[1:2]) 
             
  }
  
  } else if(input$Indicador.arima %in% c('B5N', 'B6N', 'B7N')) {
      
      tb <- data %>% 
        filter(substr(geo,1,2) == 'ES' & NUTS == 2 & na_item == input$Indicador.arima & unit == 'EUR_HAB') %>% 
        rename(Región = full_name,
               Año = TIME_PERIOD,
               valores = values) %>% 
        filter(Región %in% input$Comunidad[1:2])
    } else if(input$Indicador.arima %in% c('D4', 'D62')) {
      
      tb <- data %>% 
        filter(substr(geo,1,2) == 'ES' & NUTS == 2 & na_item == input$Indicador.arima & unit == 'MIO_EUR' & direct == 'RECV') %>%
        left_join(poblacion, by = c("TIME_PERIOD", "geo")) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(Región = full_name,
               Año = TIME_PERIOD,
               valores = per.capita) %>% 
        filter(Región %in% input$Comunidad[1:2])
    
    } else {
      
      tb <- data %>% 
        filter(substr(geo,1,2) == 'ES' & NUTS == 2 & na_item == input$Indicador.arima & unit == 'MIO_EUR') %>%
        left_join(poblacion, by = c("TIME_PERIOD", "geo")) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(Región = full_name,
               Año = TIME_PERIOD,
               valores = per.capita) %>% 
        filter(Región %in% input$Comunidad[1:2])
      
    }
  
  
  return(tb)
})
```


```{r}
shiny::renderTable({
  tb <- input.processing.arima()
  
   tb %>% 
     mutate(valores=prettyNum(round(valores,1),big.mark = ",")) %>% 
          select(Año, Región, valores) %>% 
    pivot_wider(names_from = Región, values_from = valores) %>% 
    arrange(desc(Año)) %>%
   mutate(Año=as.character(Año))
})
```


Column 
------------------------------------------

###

```{r}
renderPlotly({
  
  req(data)
  tb <- input.processing.arima()
  if(input$Scope == "Países") {
    
  ts <- tb %>% 
    select(Año, Región, valores) %>% 
    filter(Región %in% input$Pais[1]) %>% 
    mutate(Año = as.numeric(Año)) %>% 
    as_tsibble(index = Año, key = Región) %>% 
    fill_gaps()
  
  titulo <- input$Pais[1]
  
  } else {
    
    ts <- tb %>% 
    select(Año, Región, valores) %>% 
    filter(Región %in% input$Comunidad[1]) %>% 
    mutate(Año = as.numeric(Año)) %>% 
    as_tsibble(index = Año, key = Región) %>% 
    fill_gaps()
    
  titulo <- paste(input$Comunidad[1], "(€ por habitante)")  
  }
    if(input$ArimaParameters == 'free'){
      
   arima <- ts %>%
     filter(Año >= input$AñoInicialArima) %>%
     model(ARIMA(valores)) 
    } else {
   p <- as.numeric(substr(input$ArimaParameters,1,1))
   d <- as.numeric(substr(input$ArimaParameters,3,3))
   q <- as.numeric(substr(input$ArimaParameters,5,5))
   arima <-  ts %>%
   filter(Año >= input$AñoInicialArima) %>%
   model(ARIMA(valores ~ 1 + pdq(p,d,q))) 
   }
    
 forecast <- arima %>%
   forecast(h= input$Number.forecast.periods)
 
 GraficoDinamicoArima95CI(ts, "Año", "valores", forecast, titulo)
  
})
```


###


```{r}
renderPlotly({
  
  req(data)
  tb <- input.processing.arima()
  if(input$Scope == "Países") {
    
  ts <- tb %>% 
    select(Año, Región, valores) %>% 
    filter(Región %in% input$Pais[2]) %>% 
    mutate(Año = as.numeric(Año)) %>% 
    as_tsibble(index = Año, key = Región) %>% 
    fill_gaps()
  
  titulo <- input$Pais[2]
  
  } else {
    
    ts <- tb %>% 
    select(Año, Región, valores) %>% 
    filter(Región %in% input$Comunidad[2]) %>% 
    mutate(Año = as.numeric(Año)) %>% 
    as_tsibble(index = Año, key = Región) %>% 
    fill_gaps()
  titulo <- paste(input$Comunidad[2], "(€ por habitante)")  
  }
  
    if(input$ArimaParameters == 'free'){
      
   arima <- ts %>%
     filter(Año >= input$AñoInicialArima) %>%
     model(ARIMA(valores)) 
    } else {
   p <- as.numeric(substr(input$ArimaParameters,1,1))
   d <- as.numeric(substr(input$ArimaParameters,3,3))
   q <- as.numeric(substr(input$ArimaParameters,5,5))
   arima <-  ts %>%
   filter(Año >= input$AñoInicialArima) %>%
   model(ARIMA(valores ~ 1 + pdq(p,d,q))) 
   }
    
 forecast <- arima %>%
   forecast(h= input$Number.forecast.periods)
 
 GraficoDinamicoArima95CI(ts, "Año", "valores", forecast, titulo)
 
})
```


Análisis de Atributos
==================================================

Column {.tabset}
--------------------------------------------------


```{r}
tags$div(
  style = "display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end; padding-left: 20px; padding-top: 20px", 
  
  # 1. Input: Año (Mantiene tu estructura de alineación de etiqueta)
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Año:", style = "margin: 0"),
    shiny::selectInput(
      "Año.analisis",
      label = NULL,
      choices = rev(unique(data$TIME_PERIOD)),
      selected = last(data$TIME_PERIOD),
      width = '140px' 
    )
  ),
  
  # 2. Input: NUTS (Alineado horizontalmente)
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("NUTS:", style = "margin: 0"),
    shiny::selectInput(
      "NUTS.analisis",
      label = NULL,
      choices = c("0", "2"),
      selected = "0",
      width = '100px'
    )
  )
)

```

```{r}

indicadores.nuts.inicio <- c("B5N", "B6N", "B7N", "D1", "D62", "D5", "D4", "P3", "P51C")

indicadores.nuts.pca <- c("B5N", "B6N", "D1", "D62", "D5", "D4")


```

```{r}

input.processing.tboriginal <- reactive({
  
mapa_codigos_cortos <- c("B5N" = "ingreso_primario (B5N)", "B6N" = "renta_disponible (B6N)", "B7N" = "ahorro_neto (B7N)","D5" = "impuestos_s_r_p (D5)", "D1" = "remuneracion_asalariados (D1)", "D62" = "prestaciones_sociales (D62)","D4" = "rentas_prop (D4)", "P3" = "gasto_final (P3)", "P51C" = "inversion_fija (P51C)",
"D61" = "cotizaciones_sociales (D61)", "D63" = "transfer_sociales (D63)", "B2A3N" = "exc_bruto_exp_rent (B2A3N)", "D7" = "otras_transferencias (D7)")
  

  tb.original <- data %>% 
    filter(TIME_PERIOD == input$Año.analisis & NUTS == input$NUTS.analisis & unit == "MIO_EUR" & na_item  %in% indicadores.nuts.inicio) %>% 
    left_join(poblacion, by = c("geo", "TIME_PERIOD")) %>% 
    mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>%
    select(-values) %>%
    mutate(na_item = dplyr::recode(na_item, !!!mapa_codigos_cortos)) %>%
    mutate(atrib.comb = paste(na_item, "/", direct)) %>% 
    rename(values = per.capita) %>% 
    select(full_name, atrib.comb, values) %>% 
    pivot_wider(names_from = atrib.comb, values_from = values) %>% 
    rename(Región = full_name) 

  
  return(tb.original)
  
})
```


### Atributos originales

```{r}
    

shiny::renderTable({
  
    tb.original <- input.processing.tboriginal()
    
    tb.original %>%
      mutate(across(-Región, ~ prettyNum(round(., 2), big.mark = ","))) 
  
})
```

### Matriz correl.

```{r}
renderPlotly({
  
  tb.original <- input.processing.tboriginal()
  
 tb.original %>%
  select(-Región) %>% # eliminamos de la tabla las variables no-numéricas 
  cor(use='complete.obs') %>% # cálculo matriz correlación eliminando NA previamente
  plot_correlation(show_values = TRUE) 
})
```


```{r}
input.processing.tbpca <- reactive({
  
  mapa_codigos_cortos <- c("B5N" = "ingreso_primario (B5N)", "B6N" = "renta_disponible (B6N)", "B7N" = "ahorro_neto (B7N)","D5" = "impuestos_s_r_p (D5)", "D1" = "remuneracion_asalariados (D1)", "D62" = "prestaciones_sociales (D62)","D4" = "rentas_prop (D4)", "P3" = "gasto_final (P3)", "P51C" = "inversion_fija (P51C)",
"D61" = "cotizaciones_sociales (D61)", "D63" = "transfer_sociales (D63)", "B2A3N" = "exc_bruto_exp_rent (B2A3N)", "D7" = "otras_transferencias (D7)")
  
    tb.pca <- data %>% 
    filter(TIME_PERIOD == input$Año.analisis & NUTS == input$NUTS.analisis & unit == "MIO_EUR" & na_item %in% indicadores.nuts.pca) %>% 
    left_join(poblacion, by = c("geo", "TIME_PERIOD")) %>% 
    mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
    select(-values) %>% 
    rename(values = per.capita) %>% 
    mutate(na_item = dplyr::recode(na_item, !!!mapa_codigos_cortos)) %>%
    mutate(atrib.comb = paste(na_item, "/", direct)) %>% 
    select(full_name, atrib.comb, values) %>% 
    pivot_wider(names_from = atrib.comb, values_from = values) %>% 
    rename(Región = full_name) %>% 
    na.omit()
    
    return(tb.pca)
  
})
```


### Atributos estandarizados




```{r}
shiny::renderTable({
  
  tb.pca <- input.processing.tbpca()
    
    tb.pca %>% 
  column_to_rownames(var="Región") %>%
  scale() %>%
  as_tibble() %>% 
  mutate(Región = tb.pca$Región) %>%
  relocate(Región)
})
```


### Componentes principales


```{r}
input.processing.modelopca <- reactive({
  
  tb.pca <- input.processing.tbpca()
  

  tb <- tb.pca %>% 
  column_to_rownames(var="Región") 

  pca <- prcomp(tb,scale = TRUE)
  
  return(pca)
})
```

```{r}
renderTable({
  
  pca <- input.processing.modelopca()

  tb.pca <- input.processing.tbpca()
  
  pca$x %>% as_tibble()  %>% 
  mutate(Región=tb.pca$Región) %>%
  relocate(Región)
  
})
```

### Pesos combinación lineal PCA

```{r}
shiny::renderTable({
  
    pca <- input.processing.modelopca()
  
  as_tibble(pca$rotation, rownames = "Indicador")
})
```


### Varianza explicada


```{r}
  renderPlotly({
    
  pca <- input.processing.modelopca() 
    
 tibble(
  label=fct_inorder(paste("PC",1:length(pca$sdev))),
  varPercent = pca$sdev^2/sum(pca$sdev^2) * 100
) %>%
  ggplot(aes(x=label,
             y=varPercent)) +
    geom_bar(stat = "identity") +
    labs(x= "Componentes Principales", 
          y= "Porcentaje varianza explicada"
    )+
   geom_text(aes(label=paste0(round(varPercent,digits = 1),"%")), 
                 size=3,
                 colour = "blue",
                 nudge_y = 1.
             ) 
    
  })
```

### Visualización PCA

```{r}
tags$style(HTML("
  #PCx, #PCy {
    height: 30px !important;
    min-height: 30px !important;
    font-size: 12px !important;
    padding-top: 5px !important;    
    padding-bottom: 5px !important;
    line-height: 1.5 !important;
    padding-left: 10px !important;
    padding-right: 5px !important
  }

  #PCx_div, #PCy_div, .shiny-input-container {
     margin-bottom: 0px !important;
  }
 
  #contenedor_grafico_absoluto {
    position: absolute;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
  }
"))


tags$div(
  style = "height: 50px; display:flex; gap:20px; align-items:center; flex-wrap:wrap; margin-bottom: 10px;",
 
  tags$div(
    style ="display:flex; align-items:center; gap:6px; min-width:150px;",
    tags$label("Eje X:", style = "margin-bottom:0; white-space:nowrap; font-weight:bold;"),
    numericInput(
      "PCx", label = NULL, value = 1, min = 1, max = 8, step = 1, width = "50px"
    )
  ),
 
  tags$div(
    style = "display:flex; align-items:center; gap:6px; min-width:150px;",
    tags$label("Eje Y:", style = "margin-bottom:0; white-space:nowrap; font-weight:bold;"),
    shiny::numericInput(
      "PCy", label = NULL, value = 2, min = 1, max = 8, step = 1, width = "50px"
    )
  )
)



tags$div(
  id = "contenedor_grafico_absoluto",
  highcharter::highchartOutput("grafico_pca_out", height = "100%")
)


output$grafico_pca_out <- highcharter::renderHighchart({
  hchart(input.processing.modelopca(), choices = c(input$PCx, input$PCy))
})
```