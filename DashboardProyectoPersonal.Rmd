---
title: "Income of households by NUTS 2"
author: "Aythami Lorenzo"
date: "`r Sys.Date()`"
output: flexdashboard::flex_dashboard
runtime: shiny
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  cache=FALSE,  
  echo=FALSE
)
```

```{css estilo, results = 'asis', echo = FALSE}
<style>

/* --- 1. IMPORTACIÓN DE FUENTE MODERNA --- */
@import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap");

/* --- 2. ESTILO GENERAL Y FONDO --- */
body {
    font-family: "Montserrat", sans-serif;
    font-weight: 400; 
    font-size: 1em; 
    color: #2c3e50; 
    background-color: #f0f4f8; 
}

/* --- 3. CABECERA Y NAVEGACIÓN --- */
.navbar {
    background-color: #0072B2 !important; 
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); 
}
.navbar-brand, .navbar-nav > li > a {
    color: #ffffff !important;
    font-weight: 600;
    transition: background-color 0.3s ease, color 0.3s ease; /* Transición suave */
}

/* --- NUEVAS REGLAS DE HOVER Y TRANSICIÓN --- */

/* 1. Efecto HOVER: Resalta en blanco */
.navbar-nav > li > a:hover {
    color: #0072B2 !important; /* Texto cambia a azul corporativo */
    background-color: #ffffff !important; /* Fondo cambia a blanco */
    border-radius: 6px; 
}

/* 2. Regla para la Pestaña Activa (se mantiene blanca) */
.nav-tabs>li.active>a, .nav-tabs>li.active>a:focus, .nav-tabs>li.active>a:hover {
    color: #0072B2 !important; 
    background-color: #ffffff !important;
    font-weight: 700;
    border-radius: 8px 8px 0 0;
}
/* Asegurar que la pestaña activa no pierda el estilo al hacer hover */
.nav-tabs>li.active>a:hover {
    background-color: #ffffff !important; 
    color: #0072B2 !important;
}

/* --- 4. ESTILO DE LAS CAJAS/PANELES (TARJETAS FLOTANTES) --- */
.box, .panel-default {
    border: none !important;
    border-radius: 12px; 
    background-color: #ffffff;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); 
    margin-bottom: 25px;
    padding: 15px;
}

/* 5. TÍTULOS Y CONTROLES */
.panel-title {
    color: #0072B2; 
    font-weight: 700; 
    font-size: 1.1em; 
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f4f8;
}
.shiny-input-container label {
    font-weight: 600;
    color: #34495e;
}
.selectize-input {
    border-radius: 6px;
    border: 1px solid #dddddd;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); 
}
.slider-animate-button, .slider-track-high {
    background-color: #0072B2 !important; 
}
/* Estilo para la leyenda del mapa */
.legend.leaflet-control {
    border-radius: 10px !important;
    padding: 12px !important;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}
</style>
```


```{r global, include=FALSE}
# carga de librerías
library(DT)
library(googlesheets4)
library(kableExtra)
library(patchwork)
library(zoo)
library(MASS)
library(flexdashboard)
library(datasets)
library(highcharter) 
library(fpp3)
library(RColorBrewer)
library(openxlsx)  
library(leaflet)  
library(geojsonio)
library(plotly)
library(ggplot2)
library(tidyverse)
library(eurostat)
library(knitr)
library(webshot2)
library(ggrepel)
source("utilidades.R")

# asociamos funciones a determinadas librerías para evitar posibles errores 
filter <- dplyr::filter # Filtra filas según condiciones
select <- dplyr::select # Selecciona columnas
mutate <- dplyr::mutate # Crea o modifica columnas
arrange <- dplyr::arrange # Ordena filas
group_by <- dplyr::group_by # Agrupa datos
summarise <- dplyr::summarise # Resume variables (por ejemplo, con medias, conteos)
summarize <- dplyr::summarize # Lo mismo que summarise
rename <- dplyr::rename # Cambia nombres de columnas
distinct <- dplyr::distinct # Elimina filas duplicadas
slice<- dplyr::slice # Selecciona filas por posición
relocate<- dplyr::relocate # Reordena columnas

selectInput <- shiny::selectInput
```

```{r}
geoj <- geojson_read("https://ctim.es/AEDV/data/geo_countries.geojson",  what = "sp")
geoj.tb <- geoj %>% as_tibble()
```

```{r}
geoj2 <- geojson_read("https://gisco-services.ec.europa.eu/distribution/v2/nuts/geojson/NUTS_RG_20M_2024_4326_LEVL_2.geojson", what = 'sp')

geoj2.tb <- geoj2 %>% 
  as_tibble() %>% 
  rename(geo = NUTS_ID)

```

```{r}

# Diccionario maestro de códigos a nombres usado para la leyenda de los mapas coropléticos
master_indicadores <- c(
  "Ingreso primario neto" = "B5N",
  "Renta disponible neta" = "B6N",
  "Ahorro neto" = 'B7N',
  "Remuneración de los asalariados" = "D1",
  "Prestaciones sociales recibidas" = "D62",
  "Impuestos sobre renta y patrimonio" = "D5",
  "Rentas de la propiedad" = "D4",
  "Gasto en consumo final" = "P3",
  "Inversión en activos fijos" = "P51C"
)
```


```{r}
MapaCoroplético <- function(geoj,value,region_labels,legend_title){
pal <- colorQuantile("YlOrRd", value, n = 9)
p <-  geoj %>%
    leaflet() %>%  
    setView(lng = 25, lat = 22, zoom = 2)  %>% 
    addPolygons(
      fillColor = ~pal(value), 
      weight = 2,
      opacity = 1,
      color = "white",
      dashArray = "3",
      fillOpacity = 0.7,
      highlightOptions = highlightOptions( 
        weight = 2,
        color = rgb(0.2,0.2,0.2),
        dashArray = "",
        fillOpacity = 0.7,
        bringToFront = TRUE
      ),
      label = region_labels 
    ) %>% 
    addLegend("bottomleft", 
      pal = pal, 
      values = value,
      title = legend_title,
      labFormat = function(type, cuts, p) {
        n = length(cuts) 
        x = (cuts[-n] + cuts[-1])/2
        x=prettyNum(round(x,
            digits=max(5-nchar(as.character(round(max(na.omit(value))))),0)), 
            big.mark = ","
        )
        as.character(x)
      },
      opacity = 1
    )
  return(p)
}
```

```{r}
MapaCoroplético2 <- function(geoj,value,region_labels,legend_title){
pal <- colorQuantile("YlOrRd", value, n = 9)
p <-  geoj %>%
    leaflet() %>%  
    setView(lng = 10.7038, lat = 44, zoom = 4) %>% 
     addPolygons(
      fillColor = ~pal(value), 
      weight = 2,
      opacity = 1,
      color = "white",
      dashArray = "3",
      fillOpacity = 0.7,
      highlightOptions = highlightOptions( 
        weight = 2,
        color = rgb(0.2,0.2,0.2),
        dashArray = "",
        fillOpacity = 0.7,
        bringToFront = TRUE
      ),
      label = region_labels 
    ) %>% 
    addLegend("bottomleft", 
      pal = pal, 
      values = value,
      title = legend_title,
      labFormat = function(type, cuts, p) {
        n = length(cuts) 
        x = (cuts[-n] + cuts[-1])/2
        x=prettyNum(round(x,
            digits=max(5-nchar(as.character(round(max(na.omit(value))))),0)), 
            big.mark = ","
        )
        as.character(x)
      },
      opacity = 1
    )
  return(p)
}
```


```{r}
# dataset.name <- "nama_10r_2hhinc"
# data <- get_eurostat(dataset.name, time_format = 'date') %>%
  # as_tibble() %>%
  # arrange(TIME_PERIOD, geo)

data <- read.csv("nama_10r_2hhinc.csv") %>% 
  as_tibble() %>% 
  mutate(TIME_PERIOD = as.Date(TIME_PERIOD)) %>% 
  arrange(TIME_PERIOD, geo) 

```

```{r}
data <- data %>%
  mutate(TIME_PERIOD = as.numeric(format(TIME_PERIOD, "%Y"))) %>%
  filter(TIME_PERIOD > 1999 & TIME_PERIOD < 2023)

nuts_names <- get_eurostat_dic("geo") %>% # Diccionario de códigos a nombres
  as_tibble()

data <- data %>%
  left_join(nuts_names, by = c("geo" = "code_name"))

NUTS <- read_csv('http://ctim.es/AEDV/data/eurostac_real_nuts.csv')%>%
  as_tibble() %>%
  select(-full_name) 

data <- data %>%
  left_join(NUTS, by = 'geo') %>%
  relocate(full_name, freq, unit, direct, na_item, geo, TIME_PERIOD, values, .after = data$NUTS)


```


```{r message=FALSE, warning=FALSE, results= 'hide'}
poblacion <- get_eurostat("nama_10r_3popgdp", time_format = 'date') %>% 
  as_tibble() %>% 
  mutate(TIME_PERIOD = as.numeric(format(TIME_PERIOD, "%Y"))) %>% 
  rename(poblacion = values)

```



Series Temporales
=======================================================================


Column {.tabset}
--------------------------------------------------

### Países 1


```{r}
output$Indicador.paises.dinamico.ui <- shiny::renderUI({
  
  if(input$Unidad.paises == "PPS_EU27_2020_HAB") {
    opciones <- c("Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N")
  } else {
    opciones <- c("Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N",
      "Remuneración de los asalariados" = "D1",
      "Prestaciones sociales recibidas" = "D62",
      "Impuestos sobre renta y patrimonio" = "D5",
      "Rentas de la propiedad" = "D4")
  }
  
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Indicador:", style = "margin: 0"),
    shiny::selectInput(
      "Indicador.paises",
      label = NULL,
      choices = opciones,
      selected = "B6N",
      width = '240px' 
    )
  )
})
```

```{r}
tags$div(
  style = "display: flex; flex-wrap: wrap; gap: 20px;", 
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    shiny::uiOutput("Indicador.paises.dinamico.ui") 
  ),

  # 2. Input de Unidad (Al lado)
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Unidad:", style = "margin: 0"),
    shiny::selectInput(
      "Unidad.paises",
      label = NULL,
      choices = c(
        "€ por habitante" = "EUR_HAB",
        "Unidades PPS por habitante" = "PPS_EU27_2020_HAB"),
      selected = "EUR_HAB",
      width = '240px' 
    )
  )
)
```


```{r}
input.processing.series.temporales <- reactive({
  
  if (input$Unidad.paises == 'EUR_HAB') {
    unidad = "€"
  } else {
    unidad = 'PPS'
  }
  
  if(input$Indicador.paises %in% c('B5N', 'B6N')) {
    
    top_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises,
      unit == 'PPS_EU27_2020_HAB',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo1_geo <- top_paises_geo[1:7]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo1_geo)

  tb <- data %>%
    filter(
      na_item == input$Indicador.paises,
      unit == 'PPS_EU27_2020_HAB',
      geo %in% paises_para_filtrar 
    ) %>%
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
    )
  
      text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
  
  
  } else if(input$Indicador.paises %in% c('D62', 'D4')){
    
    top_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises,
      unit == 'MIO_EUR',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo1_geo <- top_paises_geo[1:7]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo1_geo)
  
  tb <- data %>%
    filter(
      na_item == input$Indicador.paises,
      unit == 'MIO_EUR',
      direct == 'RECV',
      geo %in% paises_para_filtrar 
    ) %>%
    left_join(poblacion %>%
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
      per.capita = (values * 1000000) / (poblacion * 1000)
    ) %>% 
    select(-values) %>% 
    rename(values = per.capita)
  
      text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
    
  } else {
    
    top_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises,
      unit == 'MIO_EUR',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo1_geo <- top_paises_geo[1:7]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo1_geo)
  
  tb <- data %>%
    filter(
      na_item == input$Indicador.paises,
      unit == 'MIO_EUR',
      geo %in% paises_para_filtrar 
    ) %>%
    left_join(poblacion %>%
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
      per.capita = (values * 1000000) / (poblacion * 1000)
    ) %>% 
    select(-values) %>% 
    rename(values = per.capita)
  
      text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
  
  }
  
  return (list(tb,text))
})
```

```{r}
renderPlotly({
  
  tb <- input.processing.series.temporales()[[1]]
  text <- input.processing.series.temporales()[[2]]
  
  p <- tb %>%
    ggplot(aes(x = TIME_PERIOD,
               y = values, 
               color = grupo_color,
               group = full_name,
               text = text)) +
    geom_line(linewidth = 0.8) + 
    scale_color_manual(values = c(
      "España y Canarias" = "red",
      "Otros Países" = "#0072B2"
    )) +
    facet_wrap(~ full_name,
               labeller = labeller(full_name = label_wrap_gen(width = 15))) +
    theme_minimal() + 
    labs(x = "Año", y = "") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    theme(panel.spacing.x = unit(1, "lines")) +
    theme(legend.position = "none") +
    theme(plot.margin = margin(t = 5, r = 5, b = 80, l = 15))
    
  ggplotly(p, tooltip = "text")
})

```

### Países 2


```{r}
output$Indicador.paises.dinamico.ui2 <- shiny::renderUI({
  
  if(input$Unidad.paises2 == "PPS_EU27_2020_HAB") {
    opciones <- c("Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N")
  } else {
    opciones <- c("Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N",
      "Remuneración de los asalariados" = "D1",
      "Prestaciones sociales recibidas" = "D62",
      "Impuestos sobre renta y patrimonio" = "D5",
      "Rentas de la propiedad" = "D4")
  }
  
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Indicador:", style = "margin: 0"),
    shiny::selectInput(
      "Indicador.paises2",
      label = NULL,
      choices = opciones,
      selected = "B6N",
      width = '240px' 
    )
  )
})
```

```{r}
tags$div(
  style = "display: flex; flex-wrap: wrap; gap: 20px;", 
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    shiny::uiOutput("Indicador.paises.dinamico.ui2") 
  ),

  # 2. Input de Unidad (Al lado)
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Unidad:", style = "margin: 0"),
    shiny::selectInput(
      "Unidad.paises2",
      label = NULL,
      choices = c(
        "€ por habitante" = "EUR_HAB",
        "Unidades PPS por habitante" = "PPS_EU27_2020_HAB"),
      selected = "EUR_HAB",
      width = '240px' 
    )
  )
)
```

```{r}
input.processing.series.temporales2 <- reactive({
  
  if (input$Unidad.paises2 == 'EUR_HAB') {
    unidad = "€"
  } else {
    unidad = 'PPS'
  }
  
  if(input$Indicador.paises2 %in% c('B5N', 'B6N')) {
    
    mid_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises2,
      unit == 'PPS_EU27_2020_HAB',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo2_geo <- mid_paises_geo[8:14]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo2_geo)

  tb <- data %>%
    filter(
      na_item == input$Indicador.paises2,
      unit == 'PPS_EU27_2020_HAB',
      geo %in% paises_para_filtrar 
    ) %>%
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
    )
  
    text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
  
  } else if(input$Indicador.paises2 %in% c('D62', 'D4')) {
    
    mid_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises2,
      unit == 'MIO_EUR',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo2_geo <- mid_paises_geo[8:14]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo2_geo)
  
  tb <- data %>%
    filter(
      na_item == input$Indicador.paises2,
      unit == 'MIO_EUR',
      direct == 'RECV',
      geo %in% paises_para_filtrar 
    ) %>%
    left_join(poblacion %>%
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
      per.capita = (values * 1000000) / (poblacion * 1000)
    ) %>% 
    select(-values) %>% 
    rename(values = per.capita)
  
  text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
    
  }
    
   else {
    
    mid_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises2,
      unit == 'MIO_EUR',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo2_geo <- mid_paises_geo[8:14]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo2_geo)
  
  tb <- data %>%
    filter(
      na_item == input$Indicador.paises2,
      unit == 'MIO_EUR',
      geo %in% paises_para_filtrar 
    ) %>%
    left_join(poblacion %>%
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
      per.capita = (values * 1000000) / (poblacion * 1000)
    ) %>% 
    select(-values) %>% 
    rename(values = per.capita)
  
    text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
    
  }
  
  return(list(tb,text))
})

```

```{r}
renderPlotly({
  
  tb <- input.processing.series.temporales2()[[1]]
  text <- input.processing.series.temporales2()[[2]]
  
  p <- tb %>%
    ggplot(aes(x = TIME_PERIOD, 
               y = values, 
               color = grupo_color,
               group = full_name,
               text = text)) +

    geom_line(linewidth = 0.8) + 
    scale_color_manual(values = c(
      "España y Canarias" = "red",
      "Otros Países" = "#0072B2"
    )) +
    facet_wrap(~ full_name,
               labeller = labeller(full_name = label_wrap_gen(width = 15))) +
    theme_minimal() + 
    labs(x = "Año", y = "") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    theme(panel.spacing.x = unit(1, "lines")) +
    theme(legend.position = "none") +
    theme(plot.margin = margin(t = 5, r = 5, b = 80, l = 15))
    
  ggplotly(p, tooltip = "text")
  
})
```

### Países 3

```{r}
output$Indicador.paises.dinamico.ui3 <- shiny::renderUI({
  
  if(input$Unidad.paises3 == "PPS_EU27_2020_HAB") {
    opciones <- c("Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N")
  } else {
    opciones <- c("Ingreso primario neto" = "B5N",
      "Renta disponible neta" = "B6N",
      "Remuneración de los asalariados" = "D1",
      "Prestaciones sociales recibidas" = "D62",
      "Impuestos sobre renta y patrimonio" = "D5",
      "Rentas de la propiedad" = "D4")
  }
  
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Indicador:", style = "margin: 0"),
    shiny::selectInput(
      "Indicador.paises3",
      label = NULL,
      choices = opciones,
      selected = "B6N",
      width = '240px' 
    )
  )
})
```

```{r}
tags$div(
  style = "display: flex; flex-wrap: wrap; gap: 20px;", 
  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    shiny::uiOutput("Indicador.paises.dinamico.ui3") 
  ),

  tags$div(
    style = "display: flex; align-items: center; gap: 10px;",
    tags$label("Unidad:", style = "margin: 0"),
    shiny::selectInput(
      "Unidad.paises3",
      label = NULL,
      choices = c(
        "€ por habitante" = "EUR_HAB",
        "Unidades PPS por habitante" = "PPS_EU27_2020_HAB"),
      selected = "EUR_HAB",
      width = '240px' 
    )
  )
)
```

```{r}
input.processing.series.temporales3 <- reactive({
  
  if (input$Unidad.paises3 == 'EUR_HAB') {
    unidad = "€"
  } else {
    unidad = 'PPS'
  }
  
  if(input$Indicador.paises3 %in% c('B5N', 'B6N')) {
    
    low_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises3,
      unit == 'PPS_EU27_2020_HAB',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo3_geo <- low_paises_geo[15:21]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo3_geo)

  tb <- data %>%
    filter(
      na_item == input$Indicador.paises3,
      unit == 'PPS_EU27_2020_HAB',
      geo %in% paises_para_filtrar 
    ) %>%
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
    )
  
  text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
  
  
  } else if(input$Indicador.paises3 %in% c('D62', 'D4')) {
    
    low_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises3,
      unit == 'MIO_EUR',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo3_geo <- low_paises_geo[15:21]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo3_geo)
  
  tb <- data %>%
    filter(
      na_item == input$Indicador.paises3,
      unit == 'MIO_EUR',
      direct == 'RECV',
      geo %in% paises_para_filtrar 
    ) %>%
    left_join(poblacion %>%
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
      per.capita = (values * 1000000) / (poblacion * 1000)
    ) %>% 
    select(-values) %>% 
    rename(values = per.capita)
  
  text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)

  
  } else {
    
    low_paises_geo <- data %>%
    filter(
      na_item == input$Indicador.paises3,
      unit == 'MIO_EUR',
      NUTS == 0,   
      !(geo %in% c("ES","NO"))  
    ) %>%
    group_by(geo) %>%
    summarise(
      media_valor = mean(values, na.rm = TRUE)
    ) %>%
    ungroup() %>%
    arrange(desc(media_valor)) %>% # 
    pull(geo) 
  
  paises_grupo3_geo <- low_paises_geo[15:21]
  
  paises_para_filtrar <- c("ES", "ES70", paises_grupo3_geo)
  
  tb <- data %>%
    filter(
      na_item == input$Indicador.paises3,
      unit == 'MIO_EUR',
      geo %in% paises_para_filtrar 
    ) %>%
    left_join(poblacion %>%
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
    mutate(
      grupo_color = ifelse(geo %in% c("ES", "ES70"), "España y Canarias", "Otros Países"),
      full_name = forcats::fct_relevel(full_name, "Spain", "Canarias"),
      per.capita = (values * 1000000) / (poblacion * 1000)
    ) %>% 
    select(-values) %>% 
    rename(values = per.capita)
  
    text = paste("Año: ",tb$TIME_PERIOD,
                        "<br>Valor: ",round(tb$values,1),unidad)
    
  }
  
  return(list(tb,text))
})


```


```{r}
renderPlotly({
  
  tb <- input.processing.series.temporales3()[[1]]
  text <- input.processing.series.temporales3()[[2]]
  
  p <- tb %>%
    ggplot(aes(x = TIME_PERIOD,
               y = values,
               color = grupo_color,
               group = full_name,
               text = text)) +
    geom_line(linewidth = 0.8) + 
    scale_color_manual(values = c(
      "España y Canarias" = "red",
      "Otros Países" = "#0072B2"
    )) +
    facet_wrap(~ full_name,
               labeller = labeller(full_name = label_wrap_gen(width = 15))) +
    theme_minimal() + 
    labs(x = "Año", y = "") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    theme(panel.spacing.x = unit(1, "lines")) +
    theme(legend.position = "none") +
    theme(plot.margin = margin(t = 5, r = 5, b = 80, l = 15))
    
  ggplotly(p, tooltip = "text")
})
```



### Provincias España

```{r}
div(
  style = "display: flex; align-items: center; gap: 10px;",
  tags$label("Indicador:", style = "margin: 0"),
shiny::selectInput(
  "Indicador",
  label = NULL,
  choices = c(
    "Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C"
  ),
  selected = "B6N"
))
```

```{r}
input.processing.series.temporales.provincias <- reactive({
  
  if(input$Indicador %in% c('B5N', 'B6N', 'B7N')) {
    
    tb <- data %>%
    filter(na_item == input$Indicador & unit == "EUR_HAB" & substr(geo,1,2) == "ES" & NUTS == 2)
    
  } else if(input$Indicador %in% c('D62', 'D4')) {
      
    tb <- data %>% 
      filter(na_item == input$Indicador & unit == "MIO_EUR" & direct == 'RECV' &
               substr(geo,1,2) == 'ES' & NUTS == 2) %>% 
      left_join(poblacion %>% 
                  select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
      mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
      select(-values) %>% 
      rename(values = per.capita)
    
  } else {
    tb <- data %>% 
      filter(na_item == input$Indicador & unit == "MIO_EUR" &
               substr(geo,1,2) == 'ES' & NUTS == 2) %>% 
      left_join(poblacion %>% 
                  select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
      mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
      select(-values) %>% 
      rename(values = per.capita)  
    
    }
  
    return(tb)

})
```


```{r}
renderPlotly({
  
  tb <- input.processing.series.temporales.provincias()
  
  tb.plot <- tb %>% 
    mutate(grupo_color = ifelse(geo == "ES70", "Canarias", "Otras Regiones"),
      full_name = forcats::fct_relevel(full_name, "Canarias"))
  
  p <- tb.plot %>% 
ggplot(aes(x = TIME_PERIOD,
           y = values,
           color = grupo_color,
           group = full_name,
           text = paste("Año: ",TIME_PERIOD,
                        "<br>Valor: ",round(values,1),"€"))) +
  geom_line(linewidth = 0.8) +
  scale_color_manual(values = c("Canarias" = "red", "Otras Regiones" = "#0072B2")) +
  facet_wrap(~ full_name,
             labeller = labeller(full_name = label_wrap_gen(width = 15))) +
  theme_minimal() +
  labs(x = "Año", y = "€ por habitante") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  theme(panel.spacing.x = unit(1, "lines")) +
  theme(panel.spacing.y = unit(1, "lines")) +
  theme(plot.margin = margin(t = 5, r = 5, b = 80, l = 15)) +
    theme(legend.position = 'none')
  
  ggplotly(p, tooltip = "text")
})
```

Atributos por año 
================================================

Column {.sidebar data-width=260}
-------------------------------------------------

```{r}

shiny::uiOutput("Indicador.mapa.dinamico")

output$Indicador.mapa.dinamico <- shiny::renderUI({
  
  if(input$NUTS == 2) {
    if(input$Unidad == "PPS_EU27_2020_HAB") {

        opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N")
        
    } else {
      
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Ahorro neto" = 'B7N',
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4",
    "Gasto en consumo final" = "P3",
    "Inversión en activos fijos" = "P51C")
    }
    
  } else {
    
    if(input$Unidad == "PPS_EU27_2020_HAB") {

        opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N")
        
    } else {
    
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4")
    }
  }
  
  shiny::selectInput(
    "Indicador.mapa",
    label = "Indicador",
    choices = opciones,
    selected = "B6N"
  )
  
})

shiny::selectInput(
  "Unidad",
  label = "Unidad",
  choices = c(
    "Unidades PPS por habitante" = "PPS_EU27_2020_HAB",
    "€ por habitante" = "EUR_HAB"),
  selected = "EUR_HAB"
)

shiny::selectInput(
  "NUTS",
  label = "NUTS",
  choices = c("0",
              "2"),
  selected = "2"
)


shiny::sliderInput(
  "Año",
  label = "Año",
  min = first(data$TIME_PERIOD),
  max = last(data$TIME_PERIOD),
  value = 2016,
  step = 1,
  
  ticks = FALSE
)
```

```{r}
iso_map <- tibble::tribble(
  ~geo, ~ISO_A3,
  "AT", "AUT", "BE", "BEL", "BG", "BGR", "CH", "CHE",
  "CY", "CYP", "CZ", "CZE", "DE", "DEU", "DK", "DNK",
  "EE", "EST", "EL", "GRC", "ES", "ESP", "FI", "FIN",
  "FR", "FRA", "HR", "HRV", "HU", "HUN", "IE", "IRL",
  "IS", "ISL", "IT", "ITA", "LT", "LTU", "LU", "LUX",
  "LV", "LVA", "MT", "MLT", "NL", "NLD", "NO", "NOR",
  "PL", "POL", "PT", "PRT", "RO", "ROU", "SE", "SWE",
  "SI", "SVN", "SK", "SVK", "UK", "GBR" 
)

data <- data %>% 
  left_join(iso_map, by = 'geo')
```

```{r}
input.processing.atributo.año <- reactive({
    
  
    if(input$Indicador.mapa %in% c('B5N', 'B6N')) {
    tb <- data %>% 
    filter(na_item == input$Indicador.mapa & TIME_PERIOD == input$Año 
           & unit == input$Unidad & NUTS == input$NUTS) 
      
      if(input$Unidad == 'EUR_HAB'){
        unidad = '€/HAB'
      } else {
        
        unidad = "PPS/HAB"
        
      }
      
    } else if(input$Indicador.mapa %in% c('D4', 'D62')) {
      
      tb <- data %>% 
    filter(na_item == input$Indicador.mapa & TIME_PERIOD == input$Año 
           & unit == "MIO_EUR" & NUTS == input$NUTS & direct == 'RECV') 
      
      tb <- tb %>% 
        left_join(poblacion %>% 
                    select(-freq, -unit), by = c('TIME_PERIOD', 'geo')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(values = per.capita)
      
      unidad = "€/HAB"
    } else {
      
            tb <- data %>% 
    filter(na_item == input$Indicador.mapa & TIME_PERIOD == input$Año 
           & unit == "MIO_EUR" & NUTS == input$NUTS) 
      
      tb <- tb %>% 
        left_join(poblacion %>% 
                    select(-freq, -unit), by = c('TIME_PERIOD', 'geo')) %>% 
        mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
        select(-values) %>% 
        rename(values = per.capita)
      
      unidad = "€/HAB"
    }
  
  return(list(tb, unidad))
  
})
```

### 

```{r}
shiny::renderTable({
  
  tb <- input.processing.atributo.año()[[1]] %>% 
    arrange(desc(values)) %>% 
    select(full_name, values) %>% 
    rename(Región = full_name,
           valores = values)

  tb %>% 
 mutate(valores=prettyNum(
  round(valores,
   digits=max(5-nchar(as.character(round(max(na.omit(valores))))),0)
  ),
  big.mark = ",")
 ) 
  
})
```

```{r}
input.processing.atributo.año.join <- reactive({
  
  tb <- input.processing.atributo.año()[[1]]
  unidad <- input.processing.atributo.año()[[2]]
  
  indicador<- input$Indicador.mapa
  legend_name <- names(master_indicadores)[master_indicadores == indicador]
  
  legend_title_break <- legend_name %>%
    stringr::str_replace(" sobre ", " sobre <br>") %>%
    stringr::str_replace(" de los ", " de los <br>") %>%
    stringr::str_replace(" y ", " y <br>") %>% 
    stringr::str_replace(" en ", " en <br>") %>% 
    stringr::str_replace(" primario ", " primario <br>") %>% 
    stringr::str_replace(" disponible ", " disponible <br>") %>% 
    stringr::str_replace("Ingreso ", "Ingreso <br>") %>% 
    stringr::str_replace("Renta ", "Renta <br>") %>% 
    stringr::str_replace("Prestaciones ", "Prestaciones <br>") %>% 
    stringr::str_replace(" sociales ", " sociales <br>") %>% 
    stringr::str_replace(" la ", " la <br>") 
    
  
  if (input$NUTS == "0") {
    tb <- geoj.tb %>% 
   left_join(tb, by = "ISO_A3")
    
    valor_formateado <- prettyNum(round(tb$values,digits=2), big.mark = ",", scientific = FALSE)

    etiqueta_valor <- ifelse(is.na(tb$values), 
                             "N/A", 
                             valor_formateado)

    etiqueta_unidad <- ifelse(is.na(tb$values), 
                              "", 
                              paste0("<strong>", unidad, "</strong>"))
    
etiquetas <-paste(
   "<strong> ",tb$ADMIN , 
   "</strong><br>",
   "<strong>Valor: </strong>", etiqueta_valor, etiqueta_unidad) %>%
 lapply(htmltools::HTML)
    
    mapa = geoj
    funcion = MapaCoroplético
    
  } else {
    
    tb <- geoj2.tb %>% 
      left_join(tb, by = 'geo')

    valor_formateado <- prettyNum(round(tb$values,digits=2), big.mark = ",", scientific = FALSE)

    etiqueta_valor <- ifelse(is.na(tb$values), 
                             "N/A", 
                             valor_formateado)

    etiqueta_unidad <- ifelse(is.na(tb$values), 
                              "", 
                              paste0("<strong>", unidad, "</strong>"))        
    
    
    etiquetas <-paste(
    "<strong>code</strong>: ",tb$geo ,
    "<br><strong>", tb$NUTS_NAME,
    "</strong><br><strong>Valor: </strong>", etiqueta_valor,"<strong>",etiqueta_unidad,"</strong>")  %>%
 lapply(htmltools::HTML)
    
    mapa = geoj2
    funcion = MapaCoroplético2
  }
  
  return(list(tb, mapa, etiquetas, funcion, legend_title_break))
  
})

```



Column
--------------------------------------------

###


```{r}
leaflet::renderLeaflet({
  
 tb <- input.processing.atributo.año.join()[[1]]
 mapa <- input.processing.atributo.año.join()[[2]]
 etiquetas <- input.processing.atributo.año.join()[[3]]
 funcion <- input.processing.atributo.año.join()[[4]]
 leyenda <- input.processing.atributo.año.join()[[5]]
 
 
 funcion(mapa,tb$values,etiquetas,leyenda)
})

```

ARIMA 
==================================================

Column {.sidebar data-width=290}
--------------------------------------------------


```{r}
shiny::uiOutput("Indicador.arima.dinamico")

output$Indicador.arima.dinamico <- shiny::renderUI({
  if(input$Unidad.arima == "EUR_HAB") {
    
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N",
    "Remuneración de los asalariados" = "D1",
    "Prestaciones sociales recibidas" = "D62",
    "Impuestos sobre renta y patrimonio" = "D5",
    "Rentas de la propiedad" = "D4")
    
  } else {
    
    opciones <- c("Ingreso primario neto" = "B5N",
    "Renta disponible neta" = "B6N")
    
  }
  
  shiny::selectInput(
    "Indicador.arima",
    label = "Indicador",
    choices = opciones,
    selected = "B6N"
  )
  
})

opciones <- data %>% 
  filter(NUTS == 0)

shiny::selectInput(
  "Pais",
  label = "Países (máx 2)",
  choices = unique(opciones$full_name),
  selected = c("Spain", "Portugal"),
  multiple = TRUE
)

shiny::selectInput(
  "Unidad.arima",
  label = "Unidad",
  choices = c(
    "€ por habitante" = 'EUR_HAB',
    "Unidades PPS por habitante" = 'PPS_EU27_2020_HAB'),
  selected = "EUR_HAB"
)

shiny::selectInput(
  "AñoInicialArima", 
  label = "Año Inicial para cálculo ARIMA",
  choices = unique(data$TIME_PERIOD) , 
  selected = first(data$TIME_PERIOD)
)

numericInput(
  "Number.forecast.periods",
  label = "N. Periodos Predicción:",
  value=5,
  min=2,
  max=30,
  step=1
)

selectInput(
  "ArimaParameters", 
  label = "Parámetros ARIMA p/d/q",
  choices = c('free', '0/2/0', '1/2/1', '2/2/2', '0/1/0', '1/1/1', '2/1/2'),  
  selected = 'free'
)

```

```{r}
input.processing.arima <- reactive({
  
  if(input$Indicador.arima %in% c('B5N', 'B6N')) {
      
    tb <- data %>% 
    filter(na_item == input$Indicador.arima & unit == input$Unidad.arima & NUTS == 0) %>%
    select(full_name, TIME_PERIOD, values) %>% 
    rename(Región = full_name,
           Año = TIME_PERIOD,
           valores = values) %>%
    mutate(valores=prettyNum(round(valores,1),big.mark = ",")) %>%
    filter(Región %in% input$Pais[1:2]) %>% 
    pivot_wider(names_from = Región, values_from = valores) %>% 
    arrange(desc(Año)) %>%
   mutate(Año=as.character(Año))
    
  } else if(input$Indicador.arima %in% c('D4', 'D62')) {
    
        tb <- data %>% 
    filter(na_item == input$Indicador.arima & unit == 'MIO_EUR' & NUTS == 0 & direct == 'RECV') %>%
    select(full_name, TIME_PERIOD, values, geo) %>% 
    left_join(poblacion %>% 
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
          mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
          select(-values) %>% 
    rename(Región = full_name,
           Año = TIME_PERIOD,
           valores = per.capita) %>%
    mutate(valores=prettyNum(round(valores,1),big.mark = ",")) %>%
    filter(Región %in% input$Pais[1:2]) %>%
          select(Año, Región, valores) %>% 
    pivot_wider(names_from = Región, values_from = valores) %>% 
    arrange(desc(Año)) %>%
   mutate(Año=as.character(Año))
        
  } else {
    
            tb <- data %>% 
    filter(na_item == input$Indicador.arima & unit == 'MIO_EUR' & NUTS == 0) %>%
    select(full_name, TIME_PERIOD, values, geo) %>% 
    left_join(poblacion %>% 
                select(-freq, -unit), by = c('geo', 'TIME_PERIOD')) %>% 
          mutate(per.capita = (values * 1000000) / (poblacion * 1000)) %>% 
          select(-values) %>% 
    rename(Región = full_name,
           Año = TIME_PERIOD,
           valores = per.capita) %>%
    mutate(valores=prettyNum(round(valores,1),big.mark = ",")) %>%
    filter(Región %in% input$Pais[1:2]) %>%
              select(Año, Región, valores) %>% 
    pivot_wider(names_from = Región, values_from = valores) %>% 
    arrange(desc(Año)) %>%
   mutate(Año=as.character(Año))
  }
  
  
  return(tb)
})
```


```{r}
shiny::renderTable({
  
  tb <- input.processing.arima()
  
  tb
  
})
```


